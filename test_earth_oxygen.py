"""
Модуль автотестов для проверки содержания кислорода в атмосфере Земли.

Тесты проверяют, что в статье о Земле в Википедии указано содержание кислорода 20.95%
в атмосфере планеты. Используется Selenium WebDriver для автоматизации браузера.
"""

import pytest
import re
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC


class TestEarthOxygenContent:
    """
    Основной класс тестов для проверки содержания кислорода в атмосфере Земли.

    Содержит тесты, которые ищут на странице Википедии информацию о составе атмосферы
    и проверяют, что содержание кислорода составляет 20.95%.
    """

    def setup_method(self, method):
        """
        Настройка тестового окружения перед каждым тестом.

        Инициализирует:
        - WebDriver для Firefox
        - Неявные ожидания
        - Явные ожидания WebDriverWait
        """
        self.driver = webdriver.Firefox()  # Инициализация Firefox драйвера
        self.driver.implicitly_wait(
            10
        )  # Неявное ожидание элементов - 10 секунд
        self.wait = WebDriverWait(
            self.driver, 15
        )  # Явное ожидание - 15 секунд

    def teardown_method(self, method):
        """
        Очистка после каждого теста.

        Закрывает браузер и освобождает ресурсы.
        """
        self.driver.quit()  # Закрытие браузера и завершение сессии

    def test_earth_atmosphere_oxygen_content(self):
        """
        Основной тест - проверка содержания кислорода 20.95% в атмосфере Земли.

        Шаги теста:
        1. Переход на страницу статьи "Земля" в Википедии
        2. Ожидание загрузки страницы
        3. Проверка наличия информации об атмосфере и кислороде
        4. Поиск и проверка конкретного значения 20.95%

        Ожидаемый результат:
        - На странице найдена информация о содержании кислорода 20.95% в атмосфере
        """
        print("\n=== Запуск основного теста ===")

        # 1. Переход напрямую на статью "Земля" для избежания проблем с поиском
        self.driver.get("https://ru.wikipedia.org/wiki/Земля")
        print("✓ Перешли напрямую на страницу 'Земля'")

        # 2. Ожидание загрузки страницы по наличию заголовка
        self.wait.until(EC.title_contains("Земля — Википедия"))
        print("✓ Страница 'Земля' загружена")

        # 3. Поиск информации о составе атмосферы
        page_text = self.driver.find_element(By.TAG_NAME, "body").text

        # Проверяем, что на странице есть информация об атмосфере и кислороде
        assert "атмосфер" in page_text.lower(), (
            "Информация об атмосфере не найдена"
        )
        assert "кислород" in page_text.lower(), (
            "Информация о кислороде не найдена"
        )

        # 4. Поиск конкретного значения 20,95% и его связи с кислородом
        oxygen_found = self._find_oxygen_composition()
        assert oxygen_found, (
            "Не удалось подтвердить, что 20,95% относится к содержанию кислорода в атмосфере"
        )

        print(
            "✓ Тест пройден: содержание кислорода в атмосфере Земли составляет 20,95%"
        )

    def _find_oxygen_composition(self):
        """
        Поиск состава атмосферы с содержанием кислорода.

        Использует три стратегии поиска:
        1. Поиск в таблицах (основной способ)
        2. Поиск по разделам статьи
        3. Поиск по всему тексту с анализом контекста

        Returns:
            bool: True если найден кислород с содержанием 20.95%, иначе False
        """
        print("✓ Поиск состава атмосферы...")

        # Способ 1: Поиск в таблицах (наиболее вероятное местонахождение данных)
        if self._find_in_tables():
            return True

        # Способ 2: Поиск по разделам статьи
        if self._find_in_sections():
            return True

        # Способ 3: Поиск по всему тексту с анализом контекста
        if self._find_in_full_text():
            return True

        return False

    def _find_in_tables(self):
        """
        Поиск данных о составе атмосферы в таблицах на странице.

        Таблицы - наиболее вероятное место для хранения данных о составе газов.
        Ищет таблицы, содержащие одновременно процент 20,95 и названия газов.

        Returns:
            bool: True если данные найдены в таблице, иначе False
        """
        try:
            # Находим все таблицы на странице
            tables = self.driver.find_elements(By.TAG_NAME, "table")
            print(f"✓ Проверяем {len(tables)} таблиц...")

            # Перебираем все таблицы для поиска нужных данных
            for i, table in enumerate(tables):
                table_text = table.text

                # Проверяем, что таблица содержит и проценты и названия газов
                has_percentage = "20,95" in table_text
                has_gases = any(
                    gas in table_text.lower()
                    for gas in ["кислород", "азот", "аргон"]
                )

                if has_percentage and has_gases:
                    print(f"✓ Найдена таблица с составом атмосферы (#{i + 1})")

                    # Извлекаем строки с газами для детального анализа
                    lines = table_text.split("\n")
                    gas_lines = [
                        line
                        for line in lines
                        if any(
                            gas in line.lower()
                            for gas in [
                                "кислород",
                                "азот",
                                "аргон",
                                "co₂",
                                "углекисл",
                            ]
                        )
                    ]

                    # Выводим и анализируем строки с газами
                    for line in gas_lines:
                        print(f"   {line}")
                        if "20,95" in line and "кислород" in line.lower():
                            print(
                                "✓ Найдена строка с содержанием кислорода 20,95%"
                            )
                            return True

                    # Если не нашли в одной строке, но таблица содержит нужные данные
                    if (
                        "20,95" in table_text
                        and "кислород" in table_text.lower()
                    ):
                        print("✓ Таблица содержит данные о 20,95% кислорода")
                        return True

        except Exception as e:
            print(f"✗ Ошибка при поиске в таблицах: {e}")

        return False

    def _find_in_sections(self):
        """
        Поиск данных о составе атмосферы в разделах статьи.

        Ищет разделы с заголовками, связанными с атмосферой, и проверяет их содержимое.

        Returns:
            bool: True если данные найдены в разделах, иначе False
        """
        try:
            # Ключевые слова для поиска разделов об атмосфере
            atmosphere_keywords = ["атмосфер", "atmosphere", "воздух", "газов"]

            # Ищем все заголовки разделов (h2, h3, h4)
            headers = self.driver.find_elements(By.XPATH, "//h2 | //h3 | //h4")

            for header in headers:
                header_text = header.text.lower()
                if any(
                    keyword in header_text for keyword in atmosphere_keywords
                ):
                    print(f"✓ Найден раздел: {header.text}")

                    # Получаем содержимое раздела для анализа
                    try:
                        # Ищем следующий элемент после заголовка (содержимое раздела)
                        content = header.find_element(
                            By.XPATH, "./following-sibling::*[1]"
                        )
                        content_text = content.text

                        if (
                            "20,95" in content_text
                            and "кислород" in content_text.lower()
                        ):
                            print(
                                "✓ В разделе найдены данные о содержании кислорода"
                            )
                            return True
                    except Exception:
                        print("✗ Не удалось получить содержимое раздела")

        except Exception as e:
            print(f"✗ Ошибка при поиске в разделах: {e}")

        return False

    def _find_in_full_text(self):
        """
        Поиск данных по всему тексту страницы с анализом контекста.

        Используется как резервный метод, если данные не найдены в таблицах или разделах.
        Анализирует предложения и соседние элементы вокруг числа 20,95.

        Returns:
            bool: True если данные найдены в тексте, иначе False
        """
        try:
            page_text = self.driver.find_element(By.TAG_NAME, "body").text

            # Разбиваем текст на предложения для поиска контекста
            sentences = re.split(r"[.!?]+", page_text)

            # Ищем предложения, содержащие и процент и упоминание кислорода
            for sentence in sentences:
                if "20,95" in sentence and "кислород" in sentence.lower():
                    print(f"✓ Найдено в контексте: {sentence.strip()}")
                    return True

            # Поиск элементов, содержащих 20,95 и анализ их окружения
            percentage_elements = self.driver.find_elements(
                By.XPATH, "//*[contains(text(), '20,95')]"
            )

            for element in percentage_elements:
                # Получаем расширенный контекст через родительский элемент
                try:
                    parent = element.find_element(By.XPATH, "./..")
                    parent_text = parent.text

                    if "кислород" in parent_text.lower():
                        print(
                            f"✓ Найдено в родительском элементе: {parent_text[:200]}..."
                        )
                        return True

                    # Проверяем соседние элементы
                    following_sibling = element.find_element(
                        By.XPATH, "./following-sibling::*[1]"
                    )
                    sibling_text = following_sibling.text

                    if "кислород" in sibling_text.lower():
                        print(
                            f"✓ Найдено в соседнем элементе: {sibling_text[:200]}..."
                        )
                        return True

                except Exception:
                    continue  # Продолжаем поиск, если не удалось получить контекст

        except Exception as e:
            print(f"✗ Ошибка при поиске в полном тексте: {e}")

        return False


class TestEarthOxygenContentAdvanced:
    """
    Продвинутый класс тестов с использованием регулярных выражений.

    Содержит тесты для точного извлечения процентного значения кислорода
    с использованием регулярных выражений.
    """

    def setup_method(self, method):
        """
        Настройка тестового окружения перед каждым тестом.
        """
        self.driver = webdriver.Firefox()
        self.driver.implicitly_wait(10)
        self.wait = WebDriverWait(self.driver, 15)

    def teardown_method(self, method):
        """
        Очистка после каждого теста.
        """
        self.driver.quit()

    def extract_oxygen_percentage(self, text):
        """
        Извлекает процент содержания кислорода из текста с помощью регулярных выражений.

        Args:
            text (str): Текст для анализа

        Returns:
            str or None: Значение процента в формате "20.95" или None если не найдено
        """
        # Паттерны для поиска процента кислорода в различных форматах
        patterns = [
            r"(\d+[,.]\d+)\s*%[^%]*?кислород",  # "20,95 % — кислород"
            r"кислород[^%]*?(\d+[,.]\d+)\s*%",  # "кислород — 20,95%"
            r"oxygen[^%]*?(\d+[,.]\d+)\s*%",  # "oxygen 20.95%"
            r"(\d+[,.]\d+)%[^%]*?oxygen",  # "20.95% oxygen"
        ]

        for pattern in patterns:
            matches = re.findall(pattern, text, re.IGNORECASE)
            for match in matches:
                # Проверяем, что значение находится в ожидаемом диапазоне (20-22%)
                value = float(match.replace(",", "."))
                if 20 <= value <= 22:  # Допускаем небольшую погрешность
                    return match.replace(",", ".")  # Стандартизируем формат
        return None

    def test_earth_atmosphere_oxygen_content_advanced(self):
        """
        Продвинутый тест с точным извлечения процента кислорода.

        Использует регулярные выражения для точного извлечения числового значения
        и проверяет его соответствие ожидаемому 20.95%.

        Ожидаемый результат:
        - Точное значение 20.95% успешно извлечено и проверено
        """
        print("\n=== Запуск продвинутого теста ===")

        # 1. Переход напрямую на статью "Земля"
        self.driver.get("https://ru.wikipedia.org/wiki/Земля")
        print("✓ Перешли напрямую на страницу 'Земля'")

        # 2. Ожидание загрузки страницы
        self.wait.until(EC.title_contains("Земля — Википедия"))
        print("✓ Страница 'Земля' загружена")

        # 3. Получаем весь текст страницы для анализа
        page_text = self.driver.find_element(By.TAG_NAME, "body").text

        # 4. Извлекаем точное значение с помощью регулярных выражений
        oxygen_value = self.extract_oxygen_percentage(page_text)

        if oxygen_value:
            expected_oxygen = "20.95"
            assert oxygen_value == expected_oxygen, (
                f"Содержание кислорода не соответствует ожидаемому. "
                f"Найдено: {oxygen_value}%, ожидалось: {expected_oxygen}%"
            )
            print(
                f"✓ Точное содержание кислорода в атмосфере Земли: {oxygen_value}%"
            )
        else:
            # Резервная проверка если регулярные выражения не сработали
            assert "20,95" in page_text and "кислород" in page_text.lower()
            print("✓ Содержание кислорода подтверждено (20,95%)")


class TestEarthOxygenNegative:
    """
    Класс негативных тестов для проверки обработки ошибок и граничных случаев.

    Содержит тесты, которые проверяют поведение системы при:
    - Отсутствии ожидаемых данных
    - Некорректных входных данных
    - Проблемах с доступностью ресурсов
    """

    def setup_method(self, method):
        """
        Настройка тестового окружения перед каждым тестом.
        """
        self.driver = webdriver.Firefox()
        self.driver.implicitly_wait(10)
        self.wait = WebDriverWait(self.driver, 15)

    def teardown_method(self, method):
        """
        Очистка после каждого теста.
        """
        self.driver.quit()

    def test_oxygen_data_missing_on_different_page(self):
        """
        Негативный тест: проверка отсутствия данных о кислороде на странице без атмосферы.

        Этот тест проверяет, что система корректно обрабатывает ситуацию, когда
        на странице отсутствует информация об атмосфере и кислороде.

        Ожидаемый результат:
        - Тест должен обнаружить отсутствие данных о кислороде
        - Должны сработать соответствующие проверки (assert)
        - Тест должен завершиться успешно (ожидаемый негативный сценарий)

        Сценарий:
        1. Переход на страницу статьи, где нет данных об атмосфере Земли
        2. Проверка отсутствия информации о кислороде
        3. Подтверждение что данные корректно отсутствуют
        """
        print("\n=== Запуск негативного теста: проверка отсутствия данных ===")

        # 1. Переход на страницу, где гарантированно нет данных об атмосфере Земли
        # Выбираем статью о математике - там точно нет данных о составе атмосферы
        self.driver.get("https://ru.wikipedia.org/wiki/Математика")
        print("✓ Перешли на страницу 'Математика' (без данных об атмосфере)")

        # 2. Ожидание загрузки страницы
        self.wait.until(EC.title_contains("Математика — Википедия"))
        print("✓ Страница 'Математика' загружена")

        # 3. Получаем весь текст страницы
        page_text = self.driver.find_element(By.TAG_NAME, "body").text
        print(f"✓ Получен текст страницы ({len(page_text)} символов)")

        # 4. ПРОВЕРКА ОТСУТСТВИЯ ДАННЫХ - это ожидаемое поведение в негативном тесте

        # Проверяем что на странице нет информации об атмосфере Земли
        has_atmosphere_info = "атмосфер" in page_text.lower()
        print(f"✓ Наличие информации об атмосфере: {has_atmosphere_info}")

        # Проверяем что на странице нет информации о кислороде в контексте Земли
        has_oxygen_info = any(
            keyword in page_text.lower()
            for keyword in ["кислород", "oxygen", "o₂", "20,95", "20.95"]
        )
        print(f"✓ Наличие информации о кислороде: {has_oxygen_info}")

        # 5. ОСНОВНЫЕ ПРОВЕРКИ НЕГАТИВНОГО СЦЕНАРИЯ

        # Утверждаем что информация об атмосфере Земли отсутствует
        # Это ожидаемое поведение на странице о математике
        assert not has_atmosphere_info, (
            "На странице о математике неожиданно найдена информация об атмосфере"
        )

        # Утверждаем что данные о содержании кислорода отсутствуют
        # Это также ожидаемое поведение
        assert not has_oxygen_info, (
            "На странице о математике неожиданно найдены данные о кислороде"
        )

        # 6. ДОПОЛНИТЕЛЬНЫЕ ПРОВЕРКИ ДЛЯ УВЕРЕННОСТИ

        # Проверяем что мы действительно на нужной странице
        assert "математика" in page_text.lower(), (
            "Не удалось подтвердить загрузку страницы о математике"
        )

        # Проверяем что страница содержит тему математики
        assert any(
            math_keyword in page_text.lower()
            for math_keyword in ["число", "формул", "уравнен", "теорема"]
        ), "Страница не соответствует ожидаемой тематике (математика)"

        print(
            "✓ Негативный тест пройден: данные о кислороде корректно отсутствуют"
        )
        print(
            "✓ Подтверждено: система правильно обрабатывает страницы без информации об атмосфере"
        )

    def test_extract_oxygen_from_irrelevant_text(self):
        """
        Негативный тест: проверка извлечения кислорода из текста без релевантных данных.

        Проверяет что функция извлечения процента корректно возвращает None
        при обработке текста, не содержащего данных о кислороде.

        Ожидаемый результат:
        - Функция должна возвращать None для текста без данных о кислороде
        - Не должно быть ложных срабатываний
        """
        print(
            "\n=== Запуск негативного теста: проверка извлечения из нерелевантного текста ==="
        )

        # Создаем экземпляр класса для доступа к методу извлечения
        test_class = TestEarthOxygenContentAdvanced()

        # Тексты, которые НЕ должны содержать данные о кислороде
        irrelevant_texts = [
            "Математика — наука о количественных отношениях и пространственных формах",
            "Программирование это искусство создания программного обеспечения",
            "Вкусный обед состоял из супа, второго блюда и компота",
            "Путешествие по горам было захватывающим и незабываемым",
            "Книга содержала 295 страниц интересного текста",  # Число есть, но не процент кислорода
            "Температура воздуха составляла 20,95 градусов",  # Число 20,95 в другом контексте
        ]

        for i, text in enumerate(irrelevant_texts, 1):
            result = test_class.extract_oxygen_percentage(text)
            assert result is None, (
                f"Ложное срабатывание для текста #{i}: '{text}' -> {result}"
            )
            print(f"✓ Текст #{i} корректно не содержит данных о кислороде")

        print("✓ Все нерелевантные тексты обработаны корректно")
        print("✓ Функция извлечения не дает ложных срабатываний")


def test_oxygen_percentage_extraction():
    """
    Тест функции извлечения процента кислорода.

    Проверяет корректность работы регулярных выражений на различных примерах текста.
    Используется для валидации логики извлечения данных.

    Тестовые случаи покрывают различные форматы представления данных:
    - Разные разделители (запятая и точка)
    - Разный порядок слов
    - Разные языки
    """
    test_class = TestEarthOxygenContentAdvanced()

    # Тестовые случаи с различными форматами данных
    test_cases = [
        ("20,95 % — кислород", "20.95"),  # Русский, запятая, пробелы
        ("кислород — 20,95%", "20.95"),  # Русский, обратный порядок
        ("20.95% oxygen", "20.95"),  # Английский, точка
        ("oxygen 20.95 %", "20.95"),  # Английский, пробелы
        ("Содержание: 20,95% кислорода", "20.95"),  # С префиксом
        ("кислород 20,95% в атмосфере", "20.95"),  # В предложении
    ]

    for text, expected in test_cases:
        result = test_class.extract_oxygen_percentage(text)
        assert result == expected, (
            f"Ошибка в извлечении: {text} -> {result}, ожидалось {expected}"
        )
    print("✓ Все тесты извлечения процента пройдены")


def test_oxygen_extraction_edge_cases():
    """
    Негативный юнит-тест: проверка граничных случаев извлечения кислорода.

    Проверяет обработку некорректных, пограничных и ошибочных данных.
    """
    print("\n=== Запуск негативного юнит-теста: граничные случаи ===")

    test_class = TestEarthOxygenContentAdvanced()

    # Тестовые случаи для граничных и некорректных данных
    edge_cases = [
        # Случаи которые должны возвращать None
        ("", None),  # Пустая строка
        ("кислород азот водород", None),  # Нет процентов
        ("95% кислорода", None),  # Неправильный процент
        ("2.095% кислорода", None),  # Слишком маленькое значение
        ("95.20% кислорода", None),  # Слишком большое значение
        ("20,95", None),  # Нет контекста кислорода
        ("кислород", None),  # Нет процента
        # Случаи которые могут быть интерпретированы некорректно
        (
            "Содержание кислорода 20,95% и азота 78%",
            "20.95",
        ),  # Должен найти правильный
        ("Кислород: 20,95%, Азот: 78%", "20.95"),  # Multiple percentages
    ]

    for text, expected in edge_cases:
        result = test_class.extract_oxygen_percentage(text)
        assert result == expected, (
            f"Некорректная обработка граничного случая: '{text}' -> {result}, ожидалось {expected}"
        )
        status = (
            "корректно обработан"
            if result == expected
            else "обработан с ошибкой"
        )
        print(f"✓ Граничный случай '{text[:50]}...' {status}")

    print("✓ Все граничные случаи обработаны корректно")


if __name__ == "__main__":
    """
    Точка входа для запуска тестов напрямую.

    Запускает все тесты в модуле с подробным выводом.
    """
    pytest.main([__file__, "-v", "-s"])
